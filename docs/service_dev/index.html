<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.54">


<title data-react-helmet="true">Service 开发指南 | Muta</title>

<meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="Service 开发指南 | Muta"><meta data-react-helmet="true" name="description" content="## 概念"><meta data-react-helmet="true" property="og:description" content="## 概念"><meta data-react-helmet="true" property="og:url" content="https://zhouyun-zoe.github.io/muta-docs2/docs/service_dev">

<link data-react-helmet="true" rel="shortcut icon" href="/muta-docs2/img/muta-logo.png">


<link rel="stylesheet" href="/muta-docs2/styles.e2aa70e3.css">


<link rel="preload" href="/muta-docs2/styles.5d16af36.js" as="script">

<link rel="preload" href="/muta-docs2/runtime~main.8a98f0f0.js" as="script">

<link rel="preload" href="/muta-docs2/main.c645a1d4.js" as="script">

<link rel="preload" href="/muta-docs2/1.570d2204.js" as="script">

<link rel="preload" href="/muta-docs2/2.e2d3cc65.js" as="script">

<link rel="preload" href="/muta-docs2/3.a6f7c6e9.js" as="script">

<link rel="preload" href="/muta-docs2/1be78505.009a25e0.js" as="script">

<link rel="preload" href="/muta-docs2/78ab87d2.97744ea4.js" as="script">

<link rel="preload" href="/muta-docs2/17896441.ccc93767.js" as="script">

<link rel="preload" href="/muta-docs2/660e63d5.b405c36d.js" as="script">

</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=window.matchMedia("(prefers-color-scheme: dark)"),n=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==n?t(n):e.matches&&t("dark")}()</script>
<div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top navbarHideable_OaSq"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/muta-docs2/"><img class="navbar__logo" src="/muta-docs2/img/muta-logo.png" alt="Muta Logo"><strong class="navbar__title">Muta</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/muta-docs2/docs/intro">Docs</a><a class="navbar__item navbar__link" href="/muta-docs2/blog">Blog</a><a class="navbar__item navbar__link" href="/muta-docs2/showcase">Showcase</a><a class="navbar__item navbar__link" href="/muta-docs2/docs/support">Support</a></div><div class="navbar__items navbar__items--right"><a target="_blank" rel="noopener noreferrer" href="https://github.com/nervosnetwork/muta" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_1gtM"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_keGJ moon_1gwN"></span></div><div class="react-toggle-track-x"><span class="toggle_keGJ sun_3CPA"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/muta-docs2/"><img class="navbar__logo" src="/muta-docs2/img/muta-logo.png" alt="Muta Logo"><strong class="navbar__title">Muta</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" position="left" href="/muta-docs2/docs/intro">Docs</a></li><li class="menu__list-item"><a class="menu__link" position="left" href="/muta-docs2/blog">Blog</a></li><li class="menu__list-item"><a class="menu__link" position="left" href="/muta-docs2/showcase">Showcase</a></li><li class="menu__list-item"><a class="menu__link" position="left" href="/muta-docs2/docs/support">Support</a></li><li class="menu__list-item"><a target="_blank" rel="noopener noreferrer" href="https://github.com/nervosnetwork/muta" class="menu__link" position="right">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_1kjD"><div class="docSidebarContainer_1cYp"><div class="sidebar_1kLs"><a tabindex="-1" class="sidebarLogo_3ono" href="/muta-docs2/"><img src="/muta-docs2/img/muta-logo.png" alt="Muta Logo"><strong>Muta</strong></a><div class="menu menu--responsive menu_w2sC"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_2vk4" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">介绍</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/muta-docs2/docs/intro">介绍</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">快速开始</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/muta-docs2/docs/getting_started">快速入门</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/muta-docs2/docs/config">配置说明</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/muta-docs2/docs/multi_node_deploy">多节点部署指南</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">架构设计</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/muta-docs2/docs/transaction_pool">Mempool</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/muta-docs2/docs/overlord">Overlord 架构设计</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/muta-docs2/docs/network">网络设计</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/muta-docs2/docs/storage">存储设计</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">密码学</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/muta-docs2/docs/crypto">密码学</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Service介绍</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active" tabindex="0" href="/muta-docs2/docs/service_dev">Service 开发指南</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/muta-docs2/docs/service_eg">Service 示例</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/muta-docs2/docs/built_in_service">内置 Service 说明</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">开发指南</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/muta-docs2/docs/dex">DEX 开发指南</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">接口</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/muta-docs2/docs/graphql">GraphQL</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">SDK</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/muta-docs2/docs/js_sdk">JS-SDK</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">常见问题</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/muta-docs2/docs/faq">FAQ</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">贡献说明</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/muta-docs2/docs/contribute">贡献代码</a></li></ul></li></ul></div></div></div><main class="docMainContainer_FFX1"><div class="container padding-vert--lg docItemWrapper_1cc7"><div class="row"><div class="col docItemCol_2GOA"><div class="docItemContainer_2cwg"><article><header><h1 class="docTitle_1vWb">Service 开发指南</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="概念"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#概念" title="Direct link to heading">#</a>概念</h2><p>区块链作为一种新的分布式应用，可以简单的理解成一个副本状态机，同时使用密码学做到应用数据的可验证和防篡改。一方面，多个副本的通信和一致性，由 P2P 网络、交易池和共识组件等共同完成，这些组件也是区块链架构中的底层模块，一般很少变动，所以可以固化到框架中直接提供给开发者使用。另一方面，状态机部分往往与链的具体需求和业务相关，需要由开发者进行自定义，框架提供 SDK 来让减轻这部分工作的时间成本和技术复杂度。</p><p>Muta 框架将用户自定义部分抽象成一个 Service，同时提供 <code>ServiceSDK</code> 让 Service 开发变得简单和高效。每个 Service 完成一个相对独立的功能，单独维护自己的存储和操作接口，类似一个运行在沙盒里的小型状态机。开发者可以使用 Service 开发链的治理模块、业务逻辑，甚至是将虚拟机接入区块链。除了开发自己的 Service，你也可以复用他人已经开发好的 Service，未来 Muta 框架会提供许多常见功能的 Service，如 Asset、Risc-V 虚拟机、DPoS、多签治理等等。Service 之间可以互相调用，这些 Service 共同组成了链的状态机部分，通过框架接口将状态机接入区块链底层组件，一条专属你的全新链就开发完成啦。</p><p>换句话说，使用 Muta 框架开发你自己的区块链只需 3 步：</p><ol><li>思考自己链的专属需求，确定需要哪些 Service</li><li>如果需要的 Service 有现成的，可以直接复用；如果没有，可以自己开发</li><li>将这些 Service 接入框架，编译运行！</li></ol><p>这篇文章主要介绍 Service 的组成和开发指南。在熟悉 Service 之后，可以阅读 <a href="/muta-docs2/docs/dex">开发一条 Dex 专有链</a>，学习如何使用 Muta 框架从零开发一条区块链。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="开发范式"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#开发范式" title="Direct link to heading">#</a>开发范式</h2><p>在设计 Service 时，我们希望降低开发者的开发门槛，让更多对区块链不那么熟悉的开发者也可以快速上手，开发自己的区块链。在开发体验上，我们希望向开发合约的体验靠拢，如果你已经学会了如何开发合约，那么恭喜你，你也已经学会了如何开发 Service。在开发范式上，我们把 Service 抽象成一个小型状态机，Service 包含普通状态机所拥有的组件：</p><ul><li>状态（存储）</li><li>输入（接口）</li><li>函数（逻辑）</li><li>输出（返回值）</li><li>异常和错误处理</li></ul><p>同时也包含区块链特有的一些组件：</p><ul><li>创世块配置</li><li>事件</li><li>资源消耗统计（Cycle）</li><li>与区块链相关的钩子函数，<code>before_block</code> 在一个区块执行前调用 Service 的函数，<code>after_block</code> 在一个区块执行后调用 Service 的函数</li></ul><p>接下来我们分别介绍每个组件。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="状态存储"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#状态存储" title="Direct link to heading">#</a>状态存储</h2><p>区别于普通程序的存储，区块链的存储需要使用密码学保证数据的可验证和防篡改。<code>ServiceSDK</code> 提供了一些数据类型和接口，让开发者无需关心密码学相关的部分，可以像开发普通程序一样完成状态的存储。</p><p><code>ServiceSDK</code> 提供了两类存储接口，一类是获得常见数据类型 map、array、uint64、String、Bool 的接口，使用这些数据类型的数据会自动存入区块链的世界状态中。</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-rust codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub trait ServiceSDK {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Alloc or recover a `Map` by` var_name`</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fn alloc_or_recover_map&lt;Key: &#x27;static + FixedCodec + PartialEq, Val: &#x27;static + FixedCodec&gt;(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &amp;mut self,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        var_name: &amp;str,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ) -&gt; ProtocolResult&lt;Box&lt;dyn StoreMap&lt;Key, Val&gt;&gt;&gt;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Alloc or recover a `Array` by` var_name`</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fn alloc_or_recover_array&lt;Elm: &#x27;static + FixedCodec&gt;(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &amp;mut self,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        var_name: &amp;str,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ) -&gt; ProtocolResult&lt;Box&lt;dyn StoreArray&lt;Elm&gt;&gt;&gt;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Alloc or recover a `Uint64` by` var_name`</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fn alloc_or_recover_uint64(&amp;mut self, var_name: &amp;str) -&gt; ProtocolResult&lt;Box&lt;dyn StoreUint64&gt;&gt;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Alloc or recover a `String` by` var_name`</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fn alloc_or_recover_string(&amp;mut self, var_name: &amp;str) -&gt; ProtocolResult&lt;Box&lt;dyn StoreString&gt;&gt;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Alloc or recover a `Bool` by` var_name`</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fn alloc_or_recover_bool(&amp;mut self, var_name: &amp;str) -&gt; ProtocolResult&lt;Box&lt;dyn StoreBool&gt;&gt;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">... ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div></div></div><p>如果这些数据类型不能满足你的需求，还有一类 key-value 接口：</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-rust codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub trait ServiceSDK {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Get a value from the service state by key</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fn get_value&lt;Key: FixedCodec, Ret: FixedCodec&gt;(&amp;self, key: &amp;Key)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        -&gt; ProtocolResult&lt;Option&lt;Ret&gt;&gt;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Set a value to the service state by key</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fn set_value&lt;Key: FixedCodec, Val: FixedCodec&gt;(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &amp;mut self,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        key: Key,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        val: Val,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ) -&gt; ProtocolResult&lt;()&gt;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Get a value from the specified address by key</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fn get_account_value&lt;Key: FixedCodec, Ret: FixedCodec&gt;(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &amp;self,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        address: &amp;Address,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        key: &amp;Key,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ) -&gt; ProtocolResult&lt;Option&lt;Ret&gt;&gt;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Insert a pair of key / value to the specified address</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fn set_account_value&lt;Key: FixedCodec, Val: FixedCodec&gt;(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &amp;mut self,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        address: &amp;Address,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        key: Key,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        val: Val,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ) -&gt; ProtocolResult&lt;()&gt;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">... ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div></div></div><p>使用这类接口的数据也会自动存储在世界状态中。</p><p>你需要使用结构体来封装 Service，以 Dex Service 为例：</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-rust codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// A dex service</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub struct DexService&lt;SDK: ServiceSDK&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    sdk: SDK,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    trades: Box&lt;dyn StoreMap&lt;Hash, Trade&gt;&gt;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    buy_orders: Box&lt;dyn StoreMap&lt;Hash, Order&gt;&gt;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    sell_orders: Box&lt;dyn StoreMap&lt;Hash, Order&gt;&gt;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    history_orders: Box&lt;dyn StoreMap&lt;Hash, Order&gt;&gt;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    validity: Box&lt;dyn StoreUint64&gt;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div></div></div><p>此外，Service 的结构体中需要包含实现 <code>ServiceSDK</code> trait 的数据类型，通过该类型获得 ServiceSDK 提供的能力。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="接口方法"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#接口方法" title="Direct link to heading">#</a>接口方法</h2><p>Service 通过过程宏标记方法，来提供链外和其他 Service 可以调用的接口，以 Dex Service 为例：</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-rust codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#[service]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">impl&lt;SDK: &#x27;static + ServiceSDK&gt; DexService&lt;SDK&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    #[cycles(210_00)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    #[write]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fn add_trade(&amp;mut self, ctx: ServiceContext, payload: AddTradePayload) -&gt; ProtocolResult&lt;()&gt;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    #[read]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fn get_trades(&amp;self, _ctx: ServiceContext) -&gt; ProtocolResult&lt;GetTradesResponse&gt;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">... ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div></div></div><p>给 Service 结构体绑定方法的 <code>impl</code> 块中，需要标记 <code>#[service]</code> 过程宏，该过程宏会给 Service 自动实现 <code>Service</code> trait，框架通过该 trait 和 Service 交互。</p><p>Dex Service 中定义了增加交易对和读取交易对两个接口方法，标记了 <code>#[write]</code> 的为写方法，该方法可以改变 Service 状态；标记了 <code>#[read]</code> 的为读方法，该方法不能改变 Service 状态；方法的第二个参数必须为 <code>ServiceContext</code> 类型，该类型负责管理交易执行的上下文；方法的第三个参数是可选的，定义接口的输入参数，同时需要为该类型实现序列化 trait，目前框架使用的是 json 序列化方案：</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-rust codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#[derive(Deserialize, Serialize, Clone, Debug, PartialEq, Eq)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub struct AddTradePayload {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pub base_asset: Hash,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pub counter_party: Hash,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div></div></div><p>接口方法最多只能有这 3 个参数。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="返回值和错误处理"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#返回值和错误处理" title="Direct link to heading">#</a>返回值和错误处理</h2><p>接口方法的返回值统一为 <code>ProtocolResult&lt;T&gt;</code> 类型：</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-rust codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub type ProtocolResult&lt;T&gt; = Result&lt;T, ProtocolError&gt;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#[derive(Debug, Constructor, Display)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#[display(fmt = &quot;[ProtocolError] Kind: {:?} Error: {:?}&quot;, kind, error)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub struct ProtocolError {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    kind:  ProtocolErrorKind,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    error: Box&lt;dyn Error + Send&gt;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">impl From&lt;ProtocolError&gt; for Box&lt;dyn Error + Send&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fn from(error: ProtocolError) -&gt; Self {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Box::new(error) as Box&lt;dyn Error + Send&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">impl Error for ProtocolError {}</span></div></div></div></div></div><p>每个 Service 定义自己的错误类型，并将该类型转换为 <code>ProtocolError</code> 供框架统一处理，以 Dex Service 为例</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-rust codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#[derive(Debug, Display, From)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub enum DexError {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    #[display(fmt = &quot;Parsing payload to json failed {:?}&quot;, _0)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    JsonParse(serde_json::Error),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    IllegalTrade,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    TradeExisted,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    TradeNotExisted,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    OrderOverdue,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    OrderNotExisted,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">impl std::error::Error for DexError {}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">impl From&lt;DexError&gt; for ProtocolError {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fn from(err: DexError) -&gt; ProtocolError {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ProtocolError::new(ProtocolErrorKind::Service, Box::new(err))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="创世配置"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#创世配置" title="Direct link to heading">#</a>创世配置</h2><p>如果创世块的世界状态需要包含 Service 的初始状态，可以在 Service 中通过过程宏<code>#[genesis]</code> 标注的 <code>fn init_genesis</code> 方法来完成。框架在创建创世块时，会调用 Service 中标注了 <code>#[genesis]</code> 的方法来完成初始化，该函数最多只有一个。</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-rust codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#[genesis]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">fn init_genesis(&amp;mut self, payload: GenesisPayload) -&gt; ProtocolResult&lt;()&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    self.validity.set(payload.order_validity)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="资源消耗统计：cycle"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#资源消耗统计：cycle" title="Direct link to heading">#</a>资源消耗统计：cycle</h2><p>接口方法中使用 <code>ServiceContext</code> 的 <code>fn sub_cycles</code> 接口，可以消耗一定数量的 cycles ，接口如下：</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-rust codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn sub_cycles(&amp;self, cycles: u64) -&gt; ProtocolResult&lt;()&gt;;</span></div></div></div></div></div><p>此外，如果接口方法消耗的 cycles 是固定数量，可以使用过程宏 <code>#[cycles(amount)]</code> 标记接口方法，框架会自动扣除 <code>amount</code> 数量的 cycles 。例如，创建资产方法消耗固定 210_00 数量的 cycles: </p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-rust codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#[cycles(210_00)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#[write]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">fn create_asset(&amp;mut self, ctx: ServiceContext, payload: CreateAssetPayload) -&gt; ProtocolResult&lt;Asset&gt;;</span></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="事件"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#事件" title="Direct link to heading">#</a>事件</h2><p>使用 <code>ServiceContext</code> 的 <code>fn emit_event</code> 接口，可以向链外抛出事件信息:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-rust codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn emit_event(&amp;self, message: String) -&gt; ProtocolResult&lt;()&gt; ;</span></div></div></div></div></div><p>抛出的事件 message 为 json 序列化的字符串，以 Asset Service 为例：</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-rust codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">let event = TransferEvent {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    asset_id: payload.asset_id,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    from: ctx.get_caller(),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    to: payload.to,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    value: payload.value,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">};</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let event_json = serde_json::to_string(&amp;event).map_err(AssetError::JsonParse)?;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ctx.emit_event(event_json)</span></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="servicecontext-中的其他方法"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#servicecontext-中的其他方法" title="Direct link to heading">#</a>ServiceContext 中的其他方法</h2><p>ServiceContext 维护交易执行的上下文，通过 ServiceContext 可以获取的信息有：</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-rust codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// 获取交易哈希</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn get_tx_hash(&amp;self) -&gt; Option&lt;Hash&gt;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// 获取 nonce</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn get_nonce(&amp;self) -&gt; Option&lt;Hash&gt;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// 获取 cycle 价格</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn get_cycles_price(&amp;self) -&gt; u64；</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// 获取  cycle limit</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn get_cycles_limit(&amp;self) -&gt; u64；</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// 获取已消耗 cycles 数量</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn get_cycles_used(&amp;self) -&gt; u64；</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// 获取交易发起方地址</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn get_caller(&amp;self) -&gt; Address；</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// 获取交易所在区块高度</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn get_current_height(&amp;self) -&gt; u64；</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// 获取额外信息</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn get_extra(&amp;self) -&gt; Option&lt;Bytes&gt;；</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// 获取当前区块时间戳</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn get_timestamp(&amp;self) -&gt; u64；</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// 抛出事件信息</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn emit_event(&amp;self, message: String) -&gt; ProtocolResult&lt;()&gt;；</span></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="service-调用"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#service-调用" title="Direct link to heading">#</a>Service 调用</h2><p>通过 ServiceSDK 提供 <code>fn write</code> 和 <code>fn read</code> 两个方法，可以调用其他 Service。前者可以改变被调用 Service 的状态，后者为只读调用：</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-rust codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub trait ServiceSDK {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fn read(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &amp;self,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ctx: &amp;ServiceContext,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        extra: Option&lt;Bytes&gt;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        service: &amp;str,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        method: &amp;str,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        payload: &amp;str,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ) -&gt; ProtocolResult&lt;String&gt;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fn write(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &amp;mut self,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ctx: &amp;ServiceContext,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        extra: Option&lt;Bytes&gt;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        service: &amp;str,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        method: &amp;str,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        payload: &amp;str,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ) -&gt; ProtocolResult&lt;String&gt;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">... ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div></div></div><p>第二个参数 <code>ServiceContext</code> 直接传入自身的上下文；第三个参数传入调用的任意附加信息；第四个参数为被调 Service 的名称；第五个参数为调用其他 Service 的接口方法的名称；第五个参数为调用参数 json 序列化后的字符串；</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="hook"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#hook" title="Direct link to heading">#</a>Hook</h2><p>每个区块执行前后，框架会分别调用 Service 的 hook_before、hook_after 方法, 这两个方法需分别使用 <code>#[hook_before]</code>、<code>#[hook_after]</code> 过程宏标记。Service 可借助 hook 功能完成特定逻辑，如 DPoS Service 可在 hook_after 方法中统计候选验证人抵押 token 数量，进行验证人变更等操作；Dex Service 可在 hook_after 方法中对订单进行匹配和成交操作：</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-rust codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// Hook method in dex service</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#[hook_after]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fn deal(&amp;mut self, params: &amp;ExecutorParams) -&gt; ProtocolResult&lt;()&gt;;</span></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="序列化"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#序列化" title="Direct link to heading">#</a>序列化</h2><p>Service 主要使用两种序列化方案: Json 和 <a href="https://github.com/ethereum/wiki/wiki/RLP">RLP</a>;</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="json"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#json" title="Direct link to heading">#</a>Json</h3><p>用户发送交易和返回结果，均使用 json 序列化，因此接口方法的输入参数中的 <code>payload</code> 和返回值 <code>ProtocolResult&lt;Response&gt;</code> 中的 <code>Response</code> 都需要实现 json 序列化的 trait。以 <a href="https://github.com/mkxbl/muta-tutorial-dex/tree/master/services/asset">Asset Service</a> 的 <code>fn create_asset</code> 接口方法为例：</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-rust codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// 接口方法</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#[cycles(210_00)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#[write]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">fn create_asset(&amp;mut self, ctx: ServiceContext, payload: CreateAssetPayload) -&gt; ProtocolResult&lt;Asset&gt;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// 标记 #[derive(Deserialize, Serialize)] 以实现 json 序列化</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#[derive(Deserialize, Serialize, Clone, Debug)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub struct CreateAssetPayload {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pub name:   String,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pub symbol: String,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pub supply: u64,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// 标记 #[derive(Deserialize, Serialize)] 以实现 json 序列化</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#[derive(Deserialize, Serialize, Clone, Debug)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub struct Asset {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pub id:     Hash,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pub name:   String,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pub symbol: String,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pub supply: u64,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pub issuer: Address,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div></div></div><p>Service 之间调用的参数和返回值同样使用 json 序列化，以 <a href="https://github.com/mkxbl/muta-tutorial-dex/tree/master/services/dex">Dex Service</a> 调用 <a href="https://github.com/mkxbl/muta-tutorial-dex/tree/master/services/asset">Asset Service</a> 为例：</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-rust codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// 对调用参数进行 json 序列化</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let payload_str =</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    serde_json::to_string(&amp;lock_asset_payload).map_err(DexError::JsonParse)?;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// 使用 json 序列化之后的参数，进行 service 调用</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">self.sdk.write(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &amp;self.get_call_asset_ctx(),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Some(ADMISSION_TOKEN.clone()),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;asset&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;lock&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &amp;payload_str,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">)?;</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="rlp"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#rlp" title="Direct link to heading">#</a>RLP</h3><p>对于存储到世界状态的数据结构，为了保证序列化的一致性，该数据结构需要实现 <code>trait FixedCodec</code>，我们默认使用 RLP 方案来实现该 trait 。以 <a href="https://github.com/mkxbl/muta-tutorial-dex/tree/master/services/asset">Asset Service</a> 为例：</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-rust codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// Asset 需要存入世界状态 </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub struct AssetService&lt;SDK&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    sdk:    SDK,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    assets: Box&lt;dyn StoreMap&lt;Hash, Asset&gt;&gt;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub trait FixedCodec: Sized {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fn encode_fixed(&amp;self) -&gt; ProtocolResult&lt;Bytes&gt;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fn decode_fixed(bytes: Bytes) -&gt; ProtocolResult&lt;Self&gt;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// 对 Asset 实现 trait FixedCodec</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">impl FixedCodec for Asset {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fn encode_fixed(&amp;self) -&gt; ProtocolResult&lt;Bytes&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Ok(Bytes::from(rlp::encode(self)))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fn decode_fixed(bytes: Bytes) -&gt; ProtocolResult&lt;Self&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Ok(rlp::decode(bytes.as_ref()).map_err(FixedCodecError::from)?)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// 对 Asset 实现 RLP 反序列化方案</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">impl rlp::Decodable for Asset {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fn decode(rlp: &amp;rlp::Rlp) -&gt; Result&lt;Self, rlp::DecoderError&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Ok(Self {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            id:     rlp.at(0)?.as_val()?,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            name:   rlp.at(1)?.as_val()?,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            symbol: rlp.at(2)?.as_val()?,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            supply: rlp.at(3)?.as_val()?,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            issuer: rlp.at(4)?.as_val()?,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        })</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// 对 Asset 实现 RLP 序列化方案</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">impl rlp::Encodable for Asset {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fn rlp_append(&amp;self, s: &amp;mut rlp::RlpStream) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        s.begin_list(5)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .append(&amp;self.id)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .append(&amp;self.name)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .append(&amp;self.symbol)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .append(&amp;self.supply)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .append(&amp;self.issuer);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="构造方法"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#构造方法" title="Direct link to heading">#</a>构造方法</h2><p>构造方法返回 Service 实例，以 Dex Service 为例：</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-rust codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#[service]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">impl&lt;SDK: &#x27;static + ServiceSDK&gt; DexService&lt;SDK&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pub fn new(mut sdk: SDK) -&gt; ProtocolResult&lt;Self&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let trades: Box&lt;dyn StoreMap&lt;Hash, Trade&gt;&gt; = sdk.alloc_or_recover_map(TRADES_KEY)?;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let buy_orders: Box&lt;dyn StoreMap&lt;Hash, Order&gt;&gt; =</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            sdk.alloc_or_recover_map(BUY_ORDERS_KEY)?;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let sell_orders: Box&lt;dyn StoreMap&lt;Hash, Order&gt;&gt; =</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            sdk.alloc_or_recover_map(SELL_ORDERS_KEY)?;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let history_orders: Box&lt;dyn StoreMap&lt;Hash, Order&gt;&gt; =</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            sdk.alloc_or_recover_map(HISTORY_ORDERS_KEY)?;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let validity: Box&lt;dyn StoreUint64&gt; = sdk.alloc_or_recover_uint64(VALIDITY_KEY)?;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Ok(Self {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            sdk,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            trades,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            buy_orders,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            sell_orders,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            history_orders,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            validity,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        })</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">... ...</span></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="service-示例"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#service-示例" title="Direct link to heading">#</a>Service 示例</h2><p>这里有一个功能类似 ERC-20 的 <a href="https://github.com/nervosnetwork/muta/tree/master/built-in-services/asset">Asset Service 示例</a>，读者可以查看一个 Service 的全貌。更多的 Service 示例，请参考 <a href="/muta-docs2/docs/service_eg">Service 示例</a>。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="下一站"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#下一站" title="Direct link to heading">#</a>下一站</h2><p>现在你已经对 Service 的组件和开发有了一定的认识，下一步通过学习 <a href="/muta-docs2/docs/dex">开发一条 Dex 专有链</a> ，你将对 Service 有一个更全面的理解并且学会如何使用 Muta 框架开发自己的区块链。</p><blockquote><p>注意：由于框架正在持续的开发过程中，所以框架的 api 有可能发生变动</p></blockquote></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/nervosnetwork/muta-docs/docs/service_dev.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/muta-docs2/docs/crypto"><div class="pagination-nav__link--sublabel">Previous</div><div class="pagination-nav__link--label">« 密码学</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/muta-docs2/docs/service_eg"><div class="pagination-nav__link--sublabel">Next</div><div class="pagination-nav__link--label">Service 示例 »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_TbNY"><ul class="contents contents__left-border"><li><a href="#概念" class="contents__link">概念</a></li><li><a href="#开发范式" class="contents__link">开发范式</a></li><li><a href="#状态存储" class="contents__link">状态存储</a></li><li><a href="#接口方法" class="contents__link">接口方法</a></li><li><a href="#返回值和错误处理" class="contents__link">返回值和错误处理</a></li><li><a href="#创世配置" class="contents__link">创世配置</a></li><li><a href="#资源消耗统计：cycle" class="contents__link">资源消耗统计：cycle</a></li><li><a href="#事件" class="contents__link">事件</a></li><li><a href="#servicecontext-中的其他方法" class="contents__link">ServiceContext 中的其他方法</a></li><li><a href="#service-调用" class="contents__link">Service 调用</a></li><li><a href="#hook" class="contents__link">Hook</a></li><li><a href="#序列化" class="contents__link">序列化</a><ul><li><a href="#json" class="contents__link">Json</a></li><li><a href="#rlp" class="contents__link">RLP</a></li></ul></li><li><a href="#构造方法" class="contents__link">构造方法</a></li><li><a href="#service-示例" class="contents__link">Service 示例</a></li><li><a href="#下一站" class="contents__link">下一站</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/muta-docs2/docs/doc1">Style Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/muta-docs2/docs/doc2">Second Doc</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://stackoverflow.com/questions/tagged/docusaurus">Stack Overflow</a></li><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://discordapp.com/invite/docusaurus">Discord</a></li><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://twitter.com/docusaurus">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/muta-docs2/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://github.com/facebook/docusaurus">GitHub</a></li></ul></div></div><div class="text--center"><div>Copyright © 2020 My Project, Inc. Built with Docusaurus.</div></div></div></footer>
</div>

<script src="/muta-docs2/styles.5d16af36.js"></script>

<script src="/muta-docs2/runtime~main.8a98f0f0.js"></script>

<script src="/muta-docs2/main.c645a1d4.js"></script>

<script src="/muta-docs2/1.570d2204.js"></script>

<script src="/muta-docs2/2.e2d3cc65.js"></script>

<script src="/muta-docs2/3.a6f7c6e9.js"></script>

<script src="/muta-docs2/1be78505.009a25e0.js"></script>

<script src="/muta-docs2/78ab87d2.97744ea4.js"></script>

<script src="/muta-docs2/17896441.ccc93767.js"></script>

<script src="/muta-docs2/660e63d5.b405c36d.js"></script>


</body>
</html>